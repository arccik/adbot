services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: adbot
      POSTGRES_PASSWORD: adbot
      POSTGRES_DB: adbot
    volumes:
      - dbdata:/var/lib/postgresql/data
    networks:
      - adbot

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      DATABASE_URL: postgresql://adbot:adbot@db:5432/adbot
      PORT: 4000
      JWT_SECRET: change-me
      JWT_TTL_SECONDS: 3600
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      WEB_APP_URL: ${WEB_APP_URL}
      S3_BUCKET: ${S3_BUCKET}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      AWS_REGION: ${AWS_REGION}
      CLOUDFRONT_URL: ${CLOUDFRONT_URL}
      CLOUDFRONT_KEY_PAIR_ID: ${CLOUDFRONT_KEY_PAIR_ID}
      CLOUDFRONT_PRIVATE_KEY: ${CLOUDFRONT_PRIVATE_KEY}
      CLOUDFRONT_URL_TTL_SECONDS: ${CLOUDFRONT_URL_TTL_SECONDS}
      MIN_WATCH_SECONDS: ${MIN_WATCH_SECONDS}
      MAX_DAILY_COINS: ${MAX_DAILY_COINS}
      COINS_PER_WATCH: ${COINS_PER_WATCH}
      COINS_PER_CAMPAIGN: ${COINS_PER_CAMPAIGN}
      ADMIN_API_KEY: ${ADMIN_API_KEY}
      FRAUD_IP_DAILY_LIMIT: ${FRAUD_IP_DAILY_LIMIT}
      FRAUD_FINGERPRINT_DAILY_LIMIT: ${FRAUD_FINGERPRINT_DAILY_LIMIT}
      FFPROBE_PATH: ffprobe
    depends_on:
      - db
    networks:
      - adbot

  bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    environment:
      DATABASE_URL: postgresql://adbot:adbot@db:5432/adbot
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      WEB_APP_URL: ${WEB_APP_URL}
    depends_on:
      - db
    networks:
      - adbot

  worker:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: ["node", "apps/api/dist/worker.js"]
    environment:
      DATABASE_URL: postgresql://adbot:adbot@db:5432/adbot
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      WEB_APP_URL: ${WEB_APP_URL}
      S3_BUCKET: ${S3_BUCKET}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      AWS_REGION: ${AWS_REGION}
      CLOUDFRONT_URL: ${CLOUDFRONT_URL}
      CLOUDFRONT_KEY_PAIR_ID: ${CLOUDFRONT_KEY_PAIR_ID}
      CLOUDFRONT_PRIVATE_KEY: ${CLOUDFRONT_PRIVATE_KEY}
      CLOUDFRONT_URL_TTL_SECONDS: ${CLOUDFRONT_URL_TTL_SECONDS}
      MIN_WATCH_SECONDS: ${MIN_WATCH_SECONDS}
      MAX_DAILY_COINS: ${MAX_DAILY_COINS}
      COINS_PER_WATCH: ${COINS_PER_WATCH}
      COINS_PER_CAMPAIGN: ${COINS_PER_CAMPAIGN}
      ADMIN_API_KEY: ${ADMIN_API_KEY}
      FRAUD_IP_DAILY_LIMIT: ${FRAUD_IP_DAILY_LIMIT}
      FRAUD_FINGERPRINT_DAILY_LIMIT: ${FRAUD_FINGERPRINT_DAILY_LIMIT}
      FFPROBE_PATH: ffprobe
    depends_on:
      - db
    networks:
      - adbot

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    depends_on:
      - api
    networks:
      - adbot

  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web
      - api
    networks:
      - adbot

volumes:
  dbdata:
  caddy_data:
  caddy_config:

networks:
  adbot:
    driver: bridge
